
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>  
  <meta charset="UTF-8">
  
    <title>Windows X86的ring3结构化异常处理 | DbgTech</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Andy Guo">
    

    
    <meta name="description" content="前面总结过Windows的异常分发机制，但是对于分发到指定异常处理器后的内容没有进一步总结。这个里面涉及到异常过滤和栈“展开”等内容，尤其栈“展开”一直不明白怎么回事。既然不想糊里糊涂，那就总结一下搞明白，”纸上得来终觉浅，绝知此事要躬行”。 这篇博文以seh程序为例来解析实际的应用程序中异常过滤和异常处理以及栈展开的内容。程序的代码如下代码块所示。代码非常简单，仅仅是main函数中调用了一个Se">
<meta name="keywords" content="Windbg,Exception">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows X86的ring3结构化异常处理">
<meta property="og:url" content="https://dbgtech.github.io/2017/07/26/VS2008-Windows-Try-Except-Finally.html">
<meta property="og:site_name" content="DbgTech">
<meta property="og:description" content="前面总结过Windows的异常分发机制，但是对于分发到指定异常处理器后的内容没有进一步总结。这个里面涉及到异常过滤和栈“展开”等内容，尤其栈“展开”一直不明白怎么回事。既然不想糊里糊涂，那就总结一下搞明白，”纸上得来终觉浅，绝知此事要躬行”。 这篇博文以seh程序为例来解析实际的应用程序中异常过滤和异常处理以及栈展开的内容。程序的代码如下代码块所示。代码非常简单，仅仅是main函数中调用了一个Se">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-05-19T07:03:13.412Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Windows X86的ring3结构化异常处理">
<meta name="twitter:description" content="前面总结过Windows的异常分发机制，但是对于分发到指定异常处理器后的内容没有进一步总结。这个里面涉及到异常过滤和栈“展开”等内容，尤其栈“展开”一直不明白怎么回事。既然不想糊里糊涂，那就总结一下搞明白，”纸上得来终觉浅，绝知此事要躬行”。 这篇博文以seh程序为例来解析实际的应用程序中异常过滤和异常处理以及栈展开的内容。程序的代码如下代码块所示。代码非常简单，仅仅是main函数中调用了一个Se">

    
    <link rel="alternative" href="/atom.xml" title="DbgTech" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="DbgTech" title="DbgTech"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="DbgTech">DbgTech</a></h1>
				<h2 class="blog-motto">—— 慢下来，享受思考的小确幸！</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/column">Column</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/07/26/VS2008-Windows-Try-Except-Finally.html" title="Windows X86的ring3结构化异常处理" itemprop="url">Windows X86的ring3结构化异常处理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Andy Guo" target="_blank" itemprop="author">Andy Guo</a>
		
  <p class="article-time">
    <time datetime="2017-07-26T12:52:23.000Z" itemprop="datePublished"> 发表于 2017-07-26</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			
		
		</div>
		
		<p>前面总结过Windows的异常分发机制，但是对于分发到指定异常处理器后的内容没有进一步总结。这个里面涉及到异常过滤和栈“展开”等内容，尤其栈“展开”一直不明白怎么回事。既然不想糊里糊涂，那就总结一下搞明白，”纸上得来终觉浅，绝知此事要躬行”。</p>
<p>这篇博文以seh程序为例来解析实际的应用程序中异常过滤和异常处理以及栈展开的内容。程序的代码如下代码块所示。代码非常简单，仅仅是main函数中调用了一个SehTest，在该函数中有三个__try块，一个为独立的代码块，另外两个嵌套。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;stdafx.h&quot;</span><br><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">int Filter_0(LPEXCEPTION_POINTERS p_exinfo)</span><br><span class="line">&#123;</span><br><span class="line">	if(p_exinfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_ACCESS_VIOLATION)</span><br><span class="line">	&#123;</span><br><span class="line">		printf(&quot;存储保护异常\n&quot;);</span><br><span class="line">		return 1;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">		return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int Filter_2(LPEXCEPTION_POINTERS p_exinfo)</span><br><span class="line">&#123;</span><br><span class="line">	if(p_exinfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_INT_DIVIDE_BY_ZERO)</span><br><span class="line">	&#123;</span><br><span class="line">		printf(&quot;被0除异常\n&quot;);</span><br><span class="line">		return 1;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">		return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID SehTest()</span><br><span class="line">&#123;</span><br><span class="line">	ULONG ulVal = 0;</span><br><span class="line"></span><br><span class="line">	__try // 第一个 __try 域</span><br><span class="line">	&#123;</span><br><span class="line">		ulVal = 0x11111111; // 最后一位为1表示“在 __try 代码块中”</span><br><span class="line">	&#125;</span><br><span class="line">	__except(Filter_0(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		ulVal = 0x11111110; // 最后一位为0表示“在 __except/__finally 代码块中”</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	__try // 第二个 __try 域</span><br><span class="line">	&#123;</span><br><span class="line">		ulVal = 0x22222222;</span><br><span class="line"></span><br><span class="line">		__try // 第三个 __try 域</span><br><span class="line">		&#123;</span><br><span class="line">			ulVal = 0x33333333;</span><br><span class="line"></span><br><span class="line">			*((ULONG*)NULL) = ulVal; // 触发异常</span><br><span class="line">		&#125;</span><br><span class="line">		__finally</span><br><span class="line">		&#123;</span><br><span class="line">			ulVal = 0x33333330;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	__except(Filter_2(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		ulVal = 0x22222220;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int _tmain(int argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	SehTest();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>在前面的两篇博文中（一篇Windows异常分发，一篇Windows异常处理），已经看到了RtlDispatchException负责异常分发，遇到适当的异常处理函数，则调用该处理函数。此处调用的处理器是需要程序实际执行过程中注册到TEB起始的NtTib.ExceptionList字段中的，而这个注册过程就是<code>__try</code>等关键字编译后的内容。下面就从这个SEH的<code>__try</code>编译后的代码开始来总结。</p>
<p>由于SehTest函数比较简单，如果用IDA F5之后，就剩下一个赋值操作了，关于异常处理的操作都不可见了。所以，这里将SehTest()函数的汇编代码放到这里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">.text:0042C640 ; Attributes: bp-based frame</span><br><span class="line">.text:0042C640</span><br><span class="line">.text:0042C640 ; void __cdecl SehTest()</span><br><span class="line">.text:0042C640 ?SehTest@@YAXXZ proc near</span><br><span class="line">.text:0042C640</span><br><span class="line">.text:0042C640 var_E4          = byte ptr -0E4h</span><br><span class="line">.text:0042C640 ulVal           = dword ptr -20h</span><br><span class="line">.text:0042C640 ms_exc          = CPPEH_RECORD ptr -18h</span><br><span class="line">.text:0042C640</span><br><span class="line">.text:0042C640                 push    ebp			   ; EBP, 前一个push ebp</span><br><span class="line">.text:0042C641                 mov     ebp, esp</span><br><span class="line">.text:0042C643                 push    0FFFFFFFEh      ; trylevel = TRYLEVEL_INVALID</span><br><span class="line">.text:0042C645                 push    offset stru_48FD98 ;  Scopetable</span><br><span class="line">.text:0042C64A                 push    offset __VCrtDbgReportW_SEH ; handler 其实就是_except_handler4</span><br><span class="line">.text:0042C64F                 mov     eax, large fs:0 ; prev 指针</span><br><span class="line">.text:0042C655                 push    eax</span><br><span class="line">.text:0042C656                 add     esp, 0FFFFFF2Ch ; //// 栈扩充，非try代码（////之间为非try代码）</span><br><span class="line">.text:0042C65C                 push    ebx</span><br><span class="line">.text:0042C65D                 push    esi</span><br><span class="line">.text:0042C65E                 push    edi</span><br><span class="line">.text:0042C65F                 lea     edi, [ebp+var_E4]</span><br><span class="line">.text:0042C665                 mov     ecx, 33h</span><br><span class="line">.text:0042C66A                 mov     eax, 0CCCCCCCCh</span><br><span class="line">.text:0042C66F                 rep stosd               ; ////</span><br><span class="line">.text:0042C671                 mov     eax, ___security_cookie</span><br><span class="line">.text:0042C676                 xor     [ebp+ms_exc.registration.ScopeTable], eax ; ebp-8 对ScopeTable进行异或加密</span><br><span class="line">.text:0042C679                 xor     eax, ebp        ; GS Cookie 它也不是try代码，是程序的Cookie校验</span><br><span class="line">.text:0042C67B                 push    eax</span><br><span class="line">.text:0042C67C                 lea     eax, [ebp+ms_exc.registration] ; 取栈上registration 结构体指针</span><br><span class="line">.text:0042C67F                 mov     large fs:0, eax ; 将TEB中的异常列表指针替换掉</span><br><span class="line">.text:0042C685                 mov     [ebp+ms_exc.old_esp], esp ; 保存 esp，这个在展开时会用到</span><br><span class="line">.text:0042C688                 mov     [ebp+ulVal], 0</span><br><span class="line">.text:0042C68F                 mov     [ebp+ms_exc.registration.TryLevel], 0 ; 设置TryLevel为0，即scopetable第一项负责当异常</span><br><span class="line">.text:0042C696                 mov     [ebp+ulVal], 11111111h</span><br><span class="line">.text:0042C69D                 mov     [ebp+ms_exc.registration.TryLevel], 0FFFFFFFEh ; 将trylevel恢复，表明没有异常处理负责异常了</span><br><span class="line">.text:0042C6A4                 jmp     short loc_42C6C4</span><br><span class="line">.text:0042C6A6 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C6A6</span><br><span class="line">.text:0042C6A6 $LN7:                                   ; DATA XREF: .rdata:stru_48FD98o</span><br><span class="line">.text:0042C6A6                 mov     eax, [ebp+ms_exc.exc_ptr] ; Exception filter 0 for function 42C640</span><br><span class="line">.text:0042C6A9                 push    eax             ; p_exinfo</span><br><span class="line">.text:0042C6AA                 call    j_?Filter_0@@YAHPAU_EXCEPTION_POINTERS@@@Z ; Filter_0(_EXCEPTION_POINTERS *)</span><br><span class="line">.text:0042C6AF                 add     esp, 4</span><br><span class="line">.text:0042C6B2</span><br><span class="line">.text:0042C6B2 $LN9:</span><br><span class="line">.text:0042C6B2                 retn</span><br><span class="line">.text:0042C6B3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C6B3</span><br><span class="line">.text:0042C6B3 $LN8:                                   ; DATA XREF: .rdata:stru_48FD98o</span><br><span class="line">.text:0042C6B3                 mov     esp, [ebp+ms_exc.old_esp] ; Exception handler 0 for function 42C640</span><br><span class="line">.text:0042C6B6                 mov     [ebp+ulVal], 11111110h</span><br><span class="line">.text:0042C6BD                 mov     [ebp+ms_exc.registration.TryLevel], 0FFFFFFFEh</span><br><span class="line">.text:0042C6C4</span><br><span class="line">.text:0042C6C4 loc_42C6C4:                             ; CODE XREF: SehTest(void)+64j</span><br><span class="line">.text:0042C6C4                 mov     [ebp+ms_exc.registration.TryLevel], 1 ; 修改Traylevel为1，scopetable表第二项负责当前块中异常</span><br><span class="line">.text:0042C6CB                 mov     [ebp+ulVal], 22222222h</span><br><span class="line">.text:0042C6D2                 mov     [ebp+ms_exc.registration.TryLevel], 2 ; 含义同 .text:0042C6C4</span><br><span class="line">.text:0042C6D9                 mov     [ebp+ulVal], 33333333h</span><br><span class="line">.text:0042C6E0                 mov     eax, [ebp+ulVal]</span><br><span class="line">.text:0042C6E3                 mov     large ds:0, eax</span><br><span class="line">.text:0042C6E8                 mov     [ebp+ms_exc.registration.TryLevel], 1 ; 退出trylevel为2范围，进入到trylevel 1范围</span><br><span class="line">.text:0042C6EF                 call    $LN15           ; Finally handler 2 for function 42C640</span><br><span class="line">.text:0042C6F4 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C6F4</span><br><span class="line">.text:0042C6F4 loc_42C6F4:                             ; CODE XREF: SehTest(void):$LN16j</span><br><span class="line">.text:0042C6F4                 jmp     short $LN18</span><br><span class="line">.text:0042C6F6 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C6F6</span><br><span class="line">.text:0042C6F6 $LN15:                                  ; CODE XREF: SehTest(void)+AFj</span><br><span class="line">.text:0042C6F6                                         ; DATA XREF: .rdata:stru_48FD98o</span><br><span class="line">.text:0042C6F6                 mov     [ebp+ulVal], 33333330h ; Finally handler 2 for function 42C640</span><br><span class="line">.text:0042C6FD</span><br><span class="line">.text:0042C6FD $LN16:</span><br><span class="line">.text:0042C6FD                 retn</span><br><span class="line">.text:0042C6FE ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C6FE</span><br><span class="line">.text:0042C6FE $LN18:                                  ; CODE XREF: SehTest(void):loc_42C6F4j</span><br><span class="line">.text:0042C6FE                 mov     [ebp+ms_exc.registration.TryLevel], 0FFFFFFFEh ; 将trylevel设置为TRYLEVEL_INVALID</span><br><span class="line">.text:0042C705                 jmp     short loc_42C725</span><br><span class="line">.text:0042C707 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C707</span><br><span class="line">.text:0042C707 $LN11:                                  ; DATA XREF: .rdata:stru_48FD98o</span><br><span class="line">.text:0042C707                 mov     eax, [ebp+ms_exc.exc_ptr] ; Exception filter 1 for function 42C640</span><br><span class="line">.text:0042C70A                 push    eax             ; p_exinfo</span><br><span class="line">.text:0042C70B                 call    j_?Filter_2@@YAHPAU_EXCEPTION_POINTERS@@@Z ; Filter_2(_EXCEPTION_POINTERS *)</span><br><span class="line">.text:0042C710                 add     esp, 4</span><br><span class="line">.text:0042C713</span><br><span class="line">.text:0042C713 $LN13:</span><br><span class="line">.text:0042C713                 retn</span><br><span class="line">.text:0042C714 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C714</span><br><span class="line">.text:0042C714 $LN12:                                  ; DATA XREF: .rdata:stru_48FD98o</span><br><span class="line">.text:0042C714                 mov     esp, [ebp+ms_exc.old_esp] ; Exception handler 1 for function 42C640</span><br><span class="line">.text:0042C717                 mov     [ebp+ulVal], 22222220h</span><br><span class="line">.text:0042C71E                 mov     [ebp+ms_exc.registration.TryLevel], 0FFFFFFFEh</span><br><span class="line">.text:0042C725</span><br><span class="line">.text:0042C725 loc_42C725:                             ; CODE XREF: SehTest(void)+C5j	; 退出函数准备</span><br><span class="line">.text:0042C725                 push    edx</span><br><span class="line">.text:0042C726                 mov     ecx, ebp        ; frame</span><br><span class="line">.text:0042C728                 push    eax</span><br><span class="line">.text:0042C729                 lea     edx, v          ; v</span><br><span class="line">.text:0042C72F                 call    j_@_RTC_CheckStackVars@8 ; _RTC_CheckStackVars(x,x)</span><br><span class="line">.text:0042C734                 pop     eax</span><br><span class="line">.text:0042C735                 pop     edx</span><br><span class="line">.text:0042C736                 mov     ecx, [ebp+ms_exc.registration.Next]				; 撤销掉注册的异常块</span><br><span class="line">.text:0042C739                 mov     large fs:0, ecx									; 重新赋值 TEB中异常链表头</span><br><span class="line">.text:0042C740                 pop     ecx</span><br><span class="line">.text:0042C741                 pop     edi</span><br><span class="line">.text:0042C742                 pop     esi</span><br><span class="line">.text:0042C743                 pop     ebx</span><br><span class="line">.text:0042C744                 add     esp, 0E4h</span><br><span class="line">.text:0042C74A                 cmp     ebp, esp</span><br><span class="line">.text:0042C74C                 call    j___RTC_CheckEsp</span><br><span class="line">.text:0042C751                 mov     esp, ebp</span><br><span class="line">.text:0042C753                 pop     ebp</span><br><span class="line">.text:0042C754                 retn</span><br><span class="line">.text:0042C754 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042C755                 align 4</span><br><span class="line">.text:0042C758 ; _RTC_framedesc v</span><br><span class="line">.text:0042C758 v               _RTC_framedesc &lt;1, offset dword_42C760&gt;</span><br><span class="line">.text:0042C758                                         ; DATA XREF: SehTest(void)+E9o</span><br><span class="line">.text:0042C760 dword_42C760    dd 0FFFFFFE0h, 4        ; DATA XREF: SehTest(void):vo</span><br><span class="line">.text:0042C768                 dd offset aUlval        ; &quot;ulVal&quot;</span><br><span class="line">.text:0042C76C aUlval          db &apos;ulVal&apos;,0            ; DATA XREF: SehTest(void)+128o</span><br><span class="line">.text:0042C76C ?SehTest@@YAXXZ endp</span><br><span class="line">.text:0042C76C</span><br><span class="line">.text:0042C772                 db 4Eh dup(0CCh)</span><br><span class="line">.text:0042C7C0</span><br></pre></td></tr></table></figure>
<p>对于使用了<code>__try</code>/<code>__except</code>的函数来说，它会注册异常处理信息。看如下的汇编代码中，从代码开始到<code>.text:0042C685</code>这一行构造了异常处理信息，即<code>EXCEPTION_REGISTRATION_RECORD</code>结构体（结构体的定义如下代码块所示）。从代码量上看绝不止这两个字段，其实在VS中编译时，结构体被扩展了（如下<code>_EXCEPTION_REGISTRATION</code>结构体所示）。其中prev和handler字段即<code>_EXCEPTION_REGISTRATION_RECORD</code>定义中的Next和Handler字段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _EXCEPTION_REGISTRATION_RECORD &#123;</span><br><span class="line">   struct _EXCEPTION_REGISTRATION_RECORD *Next;</span><br><span class="line">   PEXCEPTION_ROUTINE Handler;</span><br><span class="line">&#125; EXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure>
<p>typedef struct _EXCEPTION_REGISTRATION PEXCEPTION_REGISTRATION;<br>struct _EXCEPTION_REGISTRATION{<br>   DWORD old_esp;<br>   PEXCEPTION_POINTERS xpointers;<br>   struct _EXCEPTION_REGISTRATION <em>prev;<br>   void (</em>handler)(PEXCEPTION_RECORD, PEXCEPTION_REGISTRATION, PCONTEXT, PEXCEPTION_RECORD);<br>   struct scopetable_entry *scopetable;<br>   int trylevel;<br>   int _ebp;<br>};</p>
<p>从SehTest()函数中构造<code>_EXCEPTION_REGISTRATION</code>结构体可知，Scopetable指向的是一个全局变量，如下的代码块，其中注释中标识出来了Scopetable表的三项内容。从中可以看到FilterFunc和HandlerFunc就是SehTest函数中代码的部分，分别对应着exept中括号中的代码，以及except后面大括号内的内容，即对应的过滤表达式（函数）和处理代码。可以注意到第三个表项的FilterFunc字段为0，其实这是一个<code>__try/__finally</code>语句块，它显然是没有过滤表达式的，所以这个字段被设置为空了。下面将SehTest函数中的三个try对应的scopetable及其内部个字段对应函数实时调试内容列举了，并做了注释。这里不再过多解释。第二个内容是handler字段，这个字段指向的内容<code>__VCrtDbgReportW_SEH</code>，而这个代码地方直接jmp到了<code>_except_handler4</code>函数。<code>_except_handler4</code>这个函数后面会解释，这里先不做解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">.rdata:0048FD98 stru_48FD98     dd 0FFFFFFFEh           ; GSCookieOffset</span><br><span class="line">.rdata:0048FD98                 dd 0                    ; GSCookieXOROffset ; SEH scope table for function 42C640</span><br><span class="line">.rdata:0048FD98                 dd 0FFFFFF0Ch           ; EHCookieOffset</span><br><span class="line">.rdata:0048FD98                 dd 0                    ; EHCookieXOROffset</span><br><span class="line"></span><br><span class="line">.rdata:0048FD98                 dd 0FFFFFFFEh           ; ScopeRecord.EnclosingLevel</span><br><span class="line">.rdata:0048FD98                 dd offset $LN7          ; ScopeRecord.FilterFunc</span><br><span class="line">.rdata:0048FD98                 dd offset $LN8          ; ScopeRecord.HandlerFunc</span><br><span class="line"></span><br><span class="line">.rdata:0048FD98                 dd 0FFFFFFFEh           ; ScopeRecord.EnclosingLevel</span><br><span class="line">.rdata:0048FD98                 dd offset $LN11         ; ScopeRecord.FilterFunc</span><br><span class="line">.rdata:0048FD98                 dd offset $LN12         ; ScopeRecord.HandlerFunc</span><br><span class="line"></span><br><span class="line">.rdata:0048FD98                 dd 1                    ; ScopeRecord.EnclosingLevel</span><br><span class="line">.rdata:0048FD98                 dd 0                    ; ScopeRecord.FilterFunc</span><br><span class="line">.rdata:0048FD98                 dd offset $LN15         ; ScopeRecord.HandlerFunc</span><br><span class="line"></span><br><span class="line">.rdata:0048FDCC                 dd 0</span><br><span class="line">.rdata:0048FDD0                 dd 0</span><br><span class="line">.rdata:0048FDD4                 dd 0</span><br><span class="line"></span><br><span class="line">//// 实际调试中Scopetable表的内容</span><br><span class="line">0:000&gt; dds 0138fd98</span><br><span class="line">0138fd98  fffffffe</span><br><span class="line">0138fd9c  00000000</span><br><span class="line">0138fda0  ffffff0c</span><br><span class="line">0138fda4  00000000	// 做校验用的</span><br><span class="line"></span><br><span class="line">0138fda8  fffffffe</span><br><span class="line">0138fdac  0132c6a6 seh!SehTest+0x66 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 38]</span><br><span class="line">0138fdb0  0132c6b3 seh!SehTest+0x73 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 38]</span><br><span class="line"></span><br><span class="line">0138fdb4  fffffffe</span><br><span class="line">0138fdb8  0132c707 seh!SehTest+0xc7 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 58]</span><br><span class="line">0138fdbc  0132c714 seh!SehTest+0xd4 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 58]</span><br><span class="line"></span><br><span class="line">0138fdc0  00000001</span><br><span class="line">0138fdc4  00000000</span><br><span class="line">0138fdc8  0132c6f6 seh!SehTest+0xb6 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 55]</span><br><span class="line"></span><br><span class="line">0138fdcc  00000000</span><br><span class="line">0138fdd0  00000000</span><br><span class="line">0138fdd4  00000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 0132c6a6</span><br><span class="line">seh!SehTest+0x66 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 38]:</span><br><span class="line">0132c6a6 8b45ec          mov     eax,dword ptr [ebp-14h]			; 注册数据结构的成员 xpointer</span><br><span class="line">0132c6a9 50              push    eax</span><br><span class="line">0132c6aa e8fbe8ffff      call    seh!ILT+4005(?Filter_0YAHPAU_EXCEPTION_POINTERSZ) (0132afaa)	; Filter_0</span><br><span class="line">0132c6af 83c404          add     esp,4</span><br><span class="line">0132c6b2 c3              ret</span><br><span class="line"></span><br><span class="line">0:000&gt; u 0132c6b3</span><br><span class="line">seh!SehTest+0x73 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 38]:</span><br><span class="line">0132c6b3 8b65e8          mov     esp,dword ptr [ebp-18h]			; 栈展开中删除之前的调用栈，开始处理（old_esp字段）</span><br><span class="line">0132c6b6 c745e010111111  mov     dword ptr [ebp-20h],11111110h</span><br><span class="line">0132c6bd c745fcfeffffff  mov     dword ptr [ebp-4],0FFFFFFFEh</span><br><span class="line"></span><br><span class="line">0132c6c4 c745fc01000000  mov     dword ptr [ebp-4],1				; 第二个try块的代码</span><br><span class="line">0132c6cb c745e022222222  mov     dword ptr [ebp-20h],22222222h</span><br><span class="line">0132c6d2 c745fc02000000  mov     dword ptr [ebp-4],2</span><br><span class="line">0132c6d9 c745e033333333  mov     dword ptr [ebp-20h],33333333h</span><br><span class="line">0132c6e0 8b45e0          mov     eax,dword ptr [ebp-20h]</span><br><span class="line"></span><br><span class="line">0:000&gt; u 0132c707</span><br><span class="line">seh!SehTest+0xc7 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 58]:</span><br><span class="line">0132c707 8b45ec          mov     eax,dword ptr [ebp-14h]			; 注册数据结构的成员 xpointer</span><br><span class="line">0132c70a 50              push    eax</span><br><span class="line">0132c70b e8fed9ffff      call    seh!ILT+265(?Filter_2YAHPAU_EXCEPTION_POINTERSZ) (0132a10e)	; Filter_2</span><br><span class="line">0132c710 83c404          add     esp,4</span><br><span class="line">0132c713 c3              ret</span><br><span class="line"></span><br><span class="line">0:000&gt; u 0132c714</span><br><span class="line">seh!SehTest+0xd4 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 58]:</span><br><span class="line">0132c714 8b65e8          mov     esp,dword ptr [ebp-18h]			; 栈展开中删除之前的调用栈，开始处理</span><br><span class="line">0132c717 c745e020222222  mov     dword ptr [ebp-20h],22222220h</span><br><span class="line">0132c71e c745fcfeffffff  mov     dword ptr [ebp-4],0FFFFFFFEh</span><br><span class="line"></span><br><span class="line">0132c725 52              push    edx								; 校验栈变量，不属于try代码</span><br><span class="line">0132c726 8bcd            mov     ecx,ebp</span><br><span class="line">0132c728 50              push    eax</span><br><span class="line">0132c729 8d1558c73201    lea     edx,[seh!SehTest+0x118 (0132c758)]</span><br><span class="line">0132c72f e84edeffff      call    seh!ILT+1405(_RTC_CheckStackVars (0132a582)</span><br><span class="line"></span><br><span class="line">0:000&gt; u 0132c6f6</span><br><span class="line">seh!SehTest+0xb6 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 55]:</span><br><span class="line">0132c6f6 c745e030333333  mov     dword ptr [ebp-20h],33333330h		; finaly处理块，按照函数代码，该赋值结束，即退出函数</span><br><span class="line">0132c6fd c3              ret</span><br><span class="line"></span><br><span class="line">0132c6fe c745fcfeffffff  mov     dword ptr [ebp-4],0FFFFFFFEh</span><br><span class="line">0132c705 eb1e            jmp     seh!SehTest+0xe5 (0132c725)</span><br><span class="line">0132c707 8b45ec          mov     eax,dword ptr [ebp-14h]</span><br><span class="line">0132c70a 50              push    eax</span><br><span class="line">0132c70b e8fed9ffff      call    seh!ILT+265(?Filter_2YAHPAU_EXCEPTION_POINTERSZ) (0132a10e)</span><br></pre></td></tr></table></figure>
<p>再向下执行，就到了第一个try的范围内，如下代码立决了执行到将ulVal设置为0x11111111值的地方，将当时的代码做反汇编，即可发现前一句汇编为将ebp-4位置设置为了0，这个位置其实就是栈上构造的<code>_EXCEPTION_REGISTRATION</code>结构体中的tryLevel成员，如下查看<code>_EXCEPTION_REGISTRATION</code>结构体在内存中的内容即可发现值已经被设置为0了。将该成员设置为0的意思是如果在执行过程中遇到了异常，遍历处理器时，用0作为索引值找ScopeTable中的表项。这里索引为0的表项即<code>.rdata:0048FD98</code>处（IDA的反汇编内容）的表项，即代码的第一个try语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; r</span><br><span class="line">eax=0038f654 ebx=7efde000 ecx=00000000 edx=00192de8 esi=00000000 edi=0038f64c</span><br><span class="line">eip=0132c696 esp=0038f570 ebp=0038f664 iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000286</span><br><span class="line">seh!SehTest+0x56:</span><br><span class="line">0132c696 c745e011111111  mov     dword ptr [ebp-20h],11111111h ss:002b:0038f644=00000000</span><br><span class="line"></span><br><span class="line">0:000&gt; u eip - 7</span><br><span class="line">seh!SehTest+0x4f [c:\users\administrator\desktop\seh\seh\seh.cpp @ 34]:</span><br><span class="line">0132c68f c745fc00000000  mov     dword ptr [ebp-4],0</span><br><span class="line">0132c696 c745e011111111  mov     dword ptr [ebp-20h],11111111h</span><br><span class="line">0132c69d c745fcfeffffff  mov     dword ptr [ebp-4],0FFFFFFFEh</span><br><span class="line">0132c6a4 eb1e            jmp     seh!SehTest+0x84 (0132c6c4)</span><br><span class="line">0132c6a6 8b45ec          mov     eax,dword ptr [ebp-14h]</span><br><span class="line">0132c6a9 50              push    eax</span><br><span class="line">0132c6aa e8fbe8ffff      call    seh!ILT+4005(?Filter_0YAHPAU_EXCEPTION_POINTERSZ) (0132afaa)</span><br><span class="line">0132c6af 83c404          add     esp,4</span><br><span class="line"></span><br><span class="line">0:000&gt; dds ebp - 30</span><br><span class="line">0038f634  cccccccc</span><br><span class="line">0038f638  cccccccc</span><br><span class="line">0038f63c  cccccccc</span><br><span class="line">0038f640  cccccccc</span><br><span class="line">0038f644  00000000</span><br><span class="line">0038f648  cccccccc</span><br><span class="line">0038f64c  0038f570</span><br><span class="line">0038f650  023d9cf2</span><br><span class="line">0038f654  0038f774</span><br><span class="line">0038f658  0132a528 seh!ILT+1315(__except_handler4)</span><br><span class="line">0038f65c  acd90a7d</span><br><span class="line">0038f660  00000000</span><br><span class="line">0038f664  0038f738</span><br><span class="line">0038f668  0132c7e3 seh!wmain+0x23 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 70]</span><br><span class="line">0038f66c  00000000</span><br><span class="line">0038f670  00000000</span><br><span class="line">0038f674  7efde000</span><br><span class="line">0038f678  cccccccc</span><br><span class="line">0038f67c  cccccccc</span><br></pre></td></tr></table></figure>
<p>将上述代码接着执行，执行到<code>0132c6c4 c745fc01000000  mov     dword ptr [ebp-4],1</code>处，即第二个try语句的地方，可知tryLevel被设置为了0xFFFFFFFE，即TRYLEVEL_INVALID值，表明当前没有异常处理器负责当前块中的异常。再向下的try语句的代码类似，会依次修改tryLevel的值，以确定异常处理的表项索引。不再一一解释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; p</span><br><span class="line">eax=0038f654 ebx=7efde000 ecx=00000000 edx=00192de8 esi=00000000 edi=0038f64c</span><br><span class="line">eip=0132c6c4 esp=0038f570 ebp=0038f664 iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000286</span><br><span class="line">seh!SehTest+0x84:</span><br><span class="line">0132c6c4 c745fc01000000  mov     dword ptr [ebp-4],1  ss:002b:0038f660=fffffffe</span><br><span class="line">0:000&gt; r</span><br><span class="line">eax=0038f654 ebx=7efde000 ecx=00000000 edx=00192de8 esi=00000000 edi=0038f64c</span><br><span class="line">eip=0132c6c4 esp=0038f570 ebp=0038f664 iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000286</span><br><span class="line">seh!SehTest+0x84:</span><br><span class="line">0132c6c4 c745fc01000000  mov     dword ptr [ebp-4],1  ss:002b:0038f660=fffffffe</span><br><span class="line">0:000&gt; dds ebp - 30</span><br><span class="line">0038f634  cccccccc</span><br><span class="line">0038f638  cccccccc</span><br><span class="line">0038f63c  cccccccc</span><br><span class="line">0038f640  cccccccc</span><br><span class="line">0038f644  11111111</span><br><span class="line">0038f648  cccccccc</span><br><span class="line">0038f64c  0038f570</span><br><span class="line">0038f650  023d9cf2</span><br><span class="line">0038f654  0038f774</span><br><span class="line">0038f658  0132a528 seh!ILT+1315(__except_handler4)</span><br><span class="line">0038f65c  acd90a7d	//</span><br><span class="line">0038f660  fffffffe	// trylevel</span><br><span class="line">0038f664  0038f738</span><br><span class="line">0038f668  0132c7e3 seh!wmain+0x23 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 70]</span><br><span class="line">0038f66c  00000000</span><br><span class="line">0038f670  00000000</span><br><span class="line">0038f674  7efde000</span><br><span class="line">0038f678  cccccccc</span><br><span class="line">0038f67c  cccccccc</span><br><span class="line">0038f680  cccccccc</span><br><span class="line">0038f684  cccccccc</span><br></pre></td></tr></table></figure>
<p>当代码执行到如下的位置时（即<code>ulVal = 0</code>语句），可以看一下调用栈，如下代码所示。从汇编代码可以看到这一条汇编语句是向0x00000000的内存位置赋值，即向空指针赋值，这肯定会引起异常的。从前面的注册的异常块可知，当进行异常链表遍历时，肯定会遍历到我们注册的这个异常块，调用对应的过滤代码，以判断是否可以处理当前的异常。前面分析知道，异常结构中的handler字段指向的是<code>seh!_except_handler4</code>（或者说最终会跳到该函数）。这里可以在这个函数上设置一个断点，看是否真的会在异常分发中走到该函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; k</span><br><span class="line">ChildEBP RetAddr</span><br><span class="line">0038f664 0132c7e3 seh!SehTest+0xa3 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 51]</span><br><span class="line">0038f738 0132d166 seh!wmain+0x23 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 70]</span><br><span class="line">0038f784 0132d03f seh!__tmainCRTStartup+0x116 [f:\dd\vctools\crt_bld\self_x86\crt\src\crt0.c @ 266]</span><br><span class="line">0038f78c 74e0336a seh!wmainCRTStartup+0xf [f:\dd\vctools\crt_bld\self_x86\crt\src\crt0.c @ 182]</span><br><span class="line">0038f798 774e9902 kernel32!BaseThreadInitThunk+0xe</span><br><span class="line">0038f7d8 774e98d5 ntdll!__RtlUserThreadStart+0x70</span><br><span class="line">0038f7f0 00000000 ntdll!_RtlUserThreadStart+0x1b</span><br><span class="line"></span><br><span class="line">0:000&gt; r</span><br><span class="line">eax=33333333 ebx=7efde000 ecx=00000000 edx=00192de8 esi=00000000 edi=0038f64c</span><br><span class="line">eip=0132c6e3 esp=0038f570 ebp=0038f664 iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000286</span><br><span class="line">seh!SehTest+0xa3:</span><br><span class="line">0132c6e3 a300000000      mov     dword ptr ds:[00000000h],eax ds:002b:00000000=????????</span><br><span class="line"></span><br><span class="line">0:000&gt; u 0132a528</span><br><span class="line">seh!ILT+1315(__except_handler4):</span><br><span class="line">0132a528 e953280000      jmp     seh!_except_handler4 (0132cd80)</span><br><span class="line">seh!ILT+1320(?_ValidateReadYAHPBXIZ):</span><br><span class="line">0132a52d e9ae300400      jmp     seh!_ValidateRead (0136d5e0)</span><br><span class="line"></span><br><span class="line">0:000&gt; bl</span><br><span class="line"> 0 e 0132c7c0     0001 (0001)  0:**** seh!wmain</span><br><span class="line"> 1 e 0132a528     0001 (0001)  0:**** seh!ILT+1315(__except_handler4)</span><br></pre></td></tr></table></figure>
<p>单步执行以下，即可发现调试器断下来了，给出了Access violation的诊断信息，即我们赋值空指针造成的。这在异常处理一篇中可知异常首先会被分发给调试器（如果调试器存在）。如果让调试器不处理，单纯给出继续执行的指令，异常就会继续分发。“继续执行”命令执行后，可以发现再次断到调试器，这次是断点造成的程序断到调试器，断点1即我们上面给<code>__except_handler4</code>函数设置的断点。查看一下但钱的堆栈，<code>ntdll!KiUserExceptionDispatcher</code>函数即ring3层将异常分发给异常处理函数的起点（遍历异常链表的起点）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; p</span><br><span class="line">(1e08.1848): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=33333333 ebx=7efde000 ecx=00000000 edx=00192de8 esi=00000000 edi=0038f64c</span><br><span class="line">eip=0132c6e3 esp=0038f570 ebp=0038f664 iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010286</span><br><span class="line">seh!SehTest+0xa3:</span><br><span class="line">0132c6e3 a300000000      mov     dword ptr ds:[00000000h],eax ds:002b:00000000=????????</span><br><span class="line">0:000&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">eax=00000000 ebx=00000000 ecx=0132a528 edx=7751353d esi=00000000 edi=00000000</span><br><span class="line">eip=0132a528 esp=0038efd4 ebp=0038eff4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246</span><br><span class="line">seh!ILT+1315(__except_handler4):</span><br><span class="line">0132a528 e953280000      jmp     seh!_except_handler4 (0132cd80)</span><br><span class="line">0:000&gt; kv</span><br><span class="line">ChildEBP RetAddr  Args to Child</span><br><span class="line">0038eff4 775134fb 0038f0bc 0038f654 0038f10c seh!ILT+1315(__except_handler4)</span><br><span class="line">0038f018 7751349c 0038f0bc 0038f654 0038f10c ntdll!ExecuteHandler+0x24 (FPO: [5,0,3])</span><br><span class="line">0038f0a4 774c0143 0038f0bc 0038f10c 0038f0bc ntdll!RtlDispatchException+0x127 (FPO: [2,25,4])</span><br><span class="line">0038f0a4 00000000 0038f0bc 0038f10c 0038f0bc ntdll!KiUserExceptionDispatcher+0xf (FPO: [2,0,0]) (CONTEXT @ 00000008)</span><br></pre></td></tr></table></figure>
<p>根据<code>int RtlDispatchException(PEXCEPTION_RECORD pExcptRec, CONTEXT * pContext)</code>函数原型可知，第一个参数和第二个参数分别是异常记录结构体和上下文环境结构体。在windbg中看一下这两个结构体内容，如下代码块。从两个结构体可以非常清楚看到异常发生时的情况，与我们上面执行时的代码一致。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; .exr 0038f0bc</span><br><span class="line">ExceptionAddress: 0132c6e3 (seh!SehTest+0x000000a3)</span><br><span class="line">   ExceptionCode: c0000005 (Access violation)</span><br><span class="line">  ExceptionFlags: 00000000</span><br><span class="line">NumberParameters: 2</span><br><span class="line">   Parameter[0]: 00000001</span><br><span class="line">   Parameter[1]: 00000000</span><br><span class="line">Attempt to write to address 00000000</span><br><span class="line"></span><br><span class="line">0:000&gt; .cxr 0038f10c</span><br><span class="line">eax=33333333 ebx=7efde000 ecx=00000000 edx=00192de8 esi=00000000 edi=0038f64c</span><br><span class="line">eip=0132c6e3 esp=0038f570 ebp=0038f664 iopl=0         nv up ei ng nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010386</span><br><span class="line">seh!SehTest+0xa3:</span><br><span class="line">0132c6e3 a300000000      mov     dword ptr ds:[00000000h],eax ds:002b:00000000=????????</span><br><span class="line">0:000&gt; k</span><br><span class="line">  *** Stack trace for last set context - .thread/.cxr resets it</span><br><span class="line">ChildEBP RetAddr</span><br><span class="line">0038f664 0132c7e3 seh!SehTest+0xa3 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 51]</span><br><span class="line">0038f738 0132d166 seh!wmain+0x23 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 70]</span><br><span class="line">0038f784 0132d03f seh!__tmainCRTStartup+0x116 [f:\dd\vctools\crt_bld\self_x86\crt\src\crt0.c @ 266]</span><br><span class="line">0038f78c 74e0336a seh!wmainCRTStartup+0xf [f:\dd\vctools\crt_bld\self_x86\crt\src\crt0.c @ 182]</span><br><span class="line">0038f798 774e9902 kernel32!BaseThreadInitThunk+0xe</span><br><span class="line">0038f7d8 774e98d5 ntdll!__RtlUserThreadStart+0x70</span><br><span class="line">0038f7f0 00000000 ntdll!_RtlUserThreadStart+0x1b</span><br><span class="line"></span><br><span class="line">0:000&gt; u seh!SehTest+0xa3</span><br><span class="line">seh!SehTest+0xa3 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 51]:</span><br><span class="line">0132c6e3 a300000000      mov     dword ptr ds:[00000000h],eax</span><br><span class="line">0132c6e8 c745fc01000000  mov     dword ptr [ebp-4],1</span><br><span class="line">0132c6ef e802000000      call    seh!SehTest+0xb6 (0132c6f6)</span><br><span class="line">0132c6f4 eb08            jmp     seh!SehTest+0xbe (0132c6fe)</span><br><span class="line">0132c6f6 c745e030333333  mov     dword ptr [ebp-20h],33333330h</span><br><span class="line">0132c6fd c3              ret</span><br></pre></td></tr></table></figure>
<p>从断点处，即<code>_except_handler4</code>函数的调用起始，看一下该函数。它有四个参数，从栈中看一下三个参数，前三个参数不用说分别是异常信息记录结构体，注册到异常链表的异常处理结构体指针，上下文内容结构体。最后一个是DispatcherContext，没有找到比较正式的资料，仅仅从网上搜索到一些相关资料，结合实际调试的内容分析一下，也不知道这个结构体的实际大小，暂时写这么多，今后知道了更多内容，加以补充。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dds esp</span><br><span class="line">0038efd4  77513529 ntdll!ExecuteHandler2+0x26</span><br><span class="line">0038efd8  0038f0bc</span><br><span class="line">0038efdc  0038f654</span><br><span class="line">0038efe0  0038f10c</span><br><span class="line">0038efe4  0038f090	// _DISPATCHER_CONTEXT *DispatcherContext</span><br><span class="line">0038efe8  0038f654</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">_EXCEPTION_DISPOSITION __cdecl _except_handler4(_EXCEPTION_RECORD *ExceptionRecord, _EXCEPTION_REGISTRATION_RECORD *EstablisherFrame, _CONTEXT *ContextRecord, void *DispatcherContext)</span><br><span class="line"></span><br><span class="line">_DISPATCHER_CONTEXT *DispatcherContext</span><br><span class="line"></span><br><span class="line">typedef union _FRAME_POINTERS &#123;</span><br><span class="line">    struct &#123;</span><br><span class="line">        ULONG MemoryStackFp;</span><br><span class="line">        ULONG BackingStoreFp;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONGLONG FramePointers;           // used to force 8-byte alignment</span><br><span class="line">&#125; FRAME_POINTERS, *PFRAME_POINTERS;</span><br><span class="line"></span><br><span class="line">typedef struct _xDISPATCHER_CONTEXT &#123;</span><br><span class="line">    FRAME_POINTERS EstablisherFrame;</span><br><span class="line">    ULONG ControlPc;</span><br><span class="line">    struct _RUNTIME_FUNCTION *FunctionEntry;</span><br><span class="line">    PCONTEXT ContextRecord;</span><br><span class="line">&#125; DispatcherContext, *pDispatcherContext;</span><br><span class="line"></span><br><span class="line">0:000&gt; dds 0038f090</span><br><span class="line">0038f090  00000000</span><br><span class="line">0038f094  0000004d</span><br><span class="line">0038f098  00390000		// 栈底</span><br><span class="line">0038f09c  0038d000		// 当前栈 交付的内存块的“最高”位置，即压栈极限，再压就缺页中断了</span><br><span class="line">0038f0a0  00000000</span><br><span class="line">0038f0a4  0038f664		// 上一个 EXCEPTION_REGISTRATION_RECORD 结构体指针</span><br><span class="line">0038f0a8  774c0143 ntdll!KiUserExceptionDispatcher+0xf</span><br><span class="line">0038f0ac  0038f0bc		// _EXCEPTION_RECORD *ExceptionRecord</span><br><span class="line">0038f0b0  0038f10c		// _CONTEXT *ContextRecord</span><br><span class="line">0038f0b4  0038f0bc		// _EXCEPTION_RECORD *ExceptionRecord</span><br><span class="line">0038f0b8  0038f10c		// _CONTEXT *ContextRecord</span><br><span class="line">0038f0bc  c0000005		// 错误码</span><br><span class="line">0038f0c0  00000000</span><br><span class="line">0038f0c4  00000000</span><br><span class="line">0038f0c8  0132c6e3 seh!SehTest+0xa3 [c:\users\administrator\desktop\seh\seh\seh.cpp @ 51] // 返回地址</span><br><span class="line">0038f0cc  00000002		// TryLevel</span><br><span class="line">0038f0d0  00000001</span><br><span class="line">0038f0d4  00000000</span><br><span class="line">0038f0d8  00000001</span><br><span class="line">0038f0dc  00000000</span><br><span class="line">0038f0e0  00000000</span><br><span class="line">0038f0e4  00000000</span><br><span class="line">0038f0e8  00000000</span><br><span class="line">0038f0ec  00000000</span><br><span class="line">0038f0f0  00000000</span><br><span class="line">0038f0f4  00000000</span><br><span class="line">0038f0f8  00000000</span><br><span class="line">0038f0fc  00000000</span><br><span class="line">0038f100  00000000</span><br><span class="line">0038f104  00000000</span><br><span class="line">0038f108  00000000</span><br><span class="line">0038f10c  0001007f</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _EXCEPTION_RECORD &#123;</span><br><span class="line">   DWORD ExceptionCode;</span><br><span class="line">   DWORD ExceptionFlags;</span><br><span class="line">   struct _EXCEPTION_RECORD *ExceptionRecord;</span><br><span class="line">   PVOID ExceptionAddress;</span><br><span class="line">   DWORD NumberParameters;</span><br><span class="line">   ULONG_PTR ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];</span><br><span class="line">&#125; EXCEPTION_RECORD;</span><br></pre></td></tr></table></figure>
<p>对于<code>_except_handler4</code>函数也没有官方正式的源代码，这里以IDA反汇编处来的内容为准做一个简单分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">.text:0042CD80 ; Attributes: bp-based frame</span><br><span class="line">.text:0042CD80</span><br><span class="line">.text:0042CD80 ; _EXCEPTION_DISPOSITION __cdecl _except_handler4(_EXCEPTION_RECORD *ExceptionRecord, _EXCEPTION_REGISTRATION_RECORD *EstablisherFrame, _CONTEXT *ContextRecord, void *DispatcherContext)</span><br><span class="line">.text:0042CD80 __except_handler4 proc near             ; CODE XREF: ?SehTest@@YAXXZ_SEHj</span><br><span class="line">.text:0042CD80</span><br><span class="line">.text:0042CD80 FilterFunc      = dword ptr -30h</span><br><span class="line">.text:0042CD80 ScopeTable      = dword ptr -2Ch</span><br><span class="line">.text:0042CD80 TryLevel        = dword ptr -28h</span><br><span class="line">.text:0042CD80 Revalidate      = byte ptr -21h</span><br><span class="line">.text:0042CD80 RegistrationNode= dword ptr -20h</span><br><span class="line">.text:0042CD80 ScopeTableRecord= dword ptr -1Ch</span><br><span class="line">.text:0042CD80 FramePointer    = dword ptr -18h</span><br><span class="line">.text:0042CD80 EnclosingLevel  = dword ptr -14h</span><br><span class="line">.text:0042CD80 FilterResult    = dword ptr -10h</span><br><span class="line">.text:0042CD80 Disposition     = dword ptr -0Ch</span><br><span class="line">.text:0042CD80 ExceptionPointers= _EXCEPTION_POINTERS ptr -8</span><br><span class="line">.text:0042CD80 ExceptionRecord = dword ptr  8</span><br><span class="line">.text:0042CD80 EstablisherFrame= dword ptr  0Ch</span><br><span class="line">.text:0042CD80 ContextRecord   = dword ptr  10h</span><br><span class="line">.text:0042CD80 DispatcherContext= dword ptr  14h</span><br><span class="line">.text:0042CD80</span><br><span class="line">.text:0042CD80                 mov     edi, edi</span><br><span class="line">.text:0042CD82                 push    ebp</span><br><span class="line">.text:0042CD83                 mov     ebp, esp</span><br><span class="line">.text:0042CD85                 sub     esp, 30h        ; prolog 函数前序</span><br><span class="line">.text:0042CD88                 mov     [ebp+Revalidate], 0</span><br><span class="line">.text:0042CD8C                 mov     [ebp+Disposition], 1</span><br><span class="line">.text:0042CD93                 mov     eax, [ebp+EstablisherFrame] ; 本函数第二个参数 EstablisherFrame</span><br><span class="line">.text:0042CD96                 sub     eax, 8</span><br><span class="line">.text:0042CD99                 mov     [ebp+RegistrationNode], eax ; 扩展的_EXCEPTION_REGISTRATION结构体指针 赋值局部变量</span><br><span class="line">.text:0042CD9C                 mov     ecx, [ebp+RegistrationNode] ; RegistrationNode,即注册的异常节点，从old_esp算起</span><br><span class="line">.text:0042CD9F                 add     ecx, 18h					   ; 指向_EXCEPTION_REGISTRATION结构体指针 _ebp陈冠</span><br><span class="line">.text:0042CDA2                 mov     [ebp+FramePointer], ecx 	   ; 赋值局部变量FramePointer _EXCEPTION_REGISTRATION</span><br><span class="line">.text:0042CDA5                 mov     edx, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CDA8                 mov     eax, [edx+10h]  			   ; ScopeTable 指针</span><br><span class="line">.text:0042CDAB                 xor     eax, ___security_cookie 	   ; 解密，与Cookie做异或</span><br><span class="line">.text:0042CDB1                 mov     [ebp+ScopeTable], eax	   ; ScopeTable局部变量赋值</span><br><span class="line">.text:0042CDB4                 mov     ecx, [ebp+FramePointer]	   ;</span><br><span class="line">.text:0042CDB7                 push    ecx             ; FramePointer</span><br><span class="line">.text:0042CDB8                 mov     edx, [ebp+ScopeTable]</span><br><span class="line">.text:0042CDBB                 push    edx             ; ScopeTable</span><br><span class="line">.text:0042CDBC                 call    ValidateLocalCookies        ; Cookie 校验</span><br><span class="line">.text:0042CDC1                 add     esp, 8</span><br><span class="line">.text:0042CDC4                 mov     eax, [ebp+ExceptionRecord]</span><br><span class="line">.text:0042CDC7                 mov     ecx, [eax+4]    ; ExceptionFlags</span><br><span class="line">.text:0042CDCA                 and     ecx, 66h        ; pExceptionRecord-&gt;ExceptionFlags &amp; EXCEPTION_UNWIND，判断是异常处理过程还是展开过程</span><br><span class="line">.text:0042CDCD                 jnz     loc_42CEF0	   ; 跳去做展开操作</span><br><span class="line">.text:0042CDD3                 mov     edx, [ebp+ExceptionRecord]		// 本地构建_EXCEPTION_POINTERS，异常记录与上下文指针</span><br><span class="line">.text:0042CDD6                 mov     [ebp+ExceptionPointers.ExceptionRecord], edx</span><br><span class="line">.text:0042CDD9                 mov     eax, [ebp+ContextRecord]</span><br><span class="line">.text:0042CDDC                 mov     [ebp+ExceptionPointers.ContextRecord], eax</span><br><span class="line">.text:0042CDDF                 mov     ecx, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CDE2                 lea     edx, [ebp+ExceptionPointers]</span><br><span class="line">.text:0042CDE5                 mov     [ecx+4], edx    ; 注册到异常列表异常块的PEXCEPTION_POINTERS类型指针赋值</span><br><span class="line">.text:0042CDE8                 mov     eax, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CDEB                 mov     ecx, [eax+14h]  ; tryLevel 指针</span><br><span class="line">.text:0042CDEE                 mov     [ebp+TryLevel], ecx	; 赋值 TryLevel局部变量</span><br><span class="line">.text:0042CDF1                 jmp     short loc_42CDF9</span><br><span class="line">.text:0042CDF3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042CDF3</span><br><span class="line">.text:0042CDF3 loc_42CDF3:                             ; CODE XREF: __except_handler4:loc_42CEE9j</span><br><span class="line">.text:0042CDF3                 mov     edx, [ebp+EnclosingLevel] ; EXCEPTION_CONTINUE_SEARCH（0）</span><br><span class="line">.text:0042CDF6                 mov     [ebp+TryLevel], edx</span><br><span class="line">.text:0042CDF9</span><br><span class="line">.text:0042CDF9 loc_42CDF9:                             ; CODE XREF: __except_handler4+71j</span><br><span class="line">.text:0042CDF9                 cmp     [ebp+TryLevel], 0FFFFFFFEh ; TRYLEVEL_INVALID</span><br><span class="line">.text:0042CDFD                 jz      loc_42CEEE				  ; TryLevel无效，没有在异常处理范围内</span><br><span class="line">.text:0042CE03                 mov     eax, [ebp+TryLevel]</span><br><span class="line">.text:0042CE06                 imul    eax, 0Ch        ; scopetable一个Item是12个字节，level，filter，handler</span><br><span class="line">.text:0042CE09                 mov     ecx, [ebp+ScopeTable]</span><br><span class="line">.text:0042CE0C                 lea     edx, [ecx+eax+10h] ; 这里加10h 是略过其实16个校验字节</span><br><span class="line">.text:0042CE10                 mov     [ebp+ScopeTableRecord], edx ; ScopeTableRecord 直接指向了对应的表项</span><br><span class="line">.text:0042CE13                 mov     eax, [ebp+ScopeTableRecord]</span><br><span class="line">.text:0042CE16                 mov     ecx, [eax+4]    ; Filter函数</span><br><span class="line">.text:0042CE19                 mov     [ebp+FilterFunc], ecx</span><br><span class="line">.text:0042CE1C                 mov     edx, [ebp+ScopeTableRecord]</span><br><span class="line">.text:0042CE1F                 mov     eax, [edx]      ; LastTryLevel</span><br><span class="line">.text:0042CE21                 mov     [ebp+EnclosingLevel], eax	; EnclosingLevel是外层try在Scope表中的索引，用于循环</span><br><span class="line">.text:0042CE24                 cmp     [ebp+FilterFunc], 0			; 过滤函数为空，则继续循环外层</span><br><span class="line">.text:0042CE28                 jz      loc_42CEE9</span><br><span class="line">.text:0042CE2E                 mov     edx, [ebp+FramePointer]		; 如果过滤函数非空，则调用</span><br><span class="line">.text:0042CE31                 mov     ecx, [ebp+FilterFunc]</span><br><span class="line">.text:0042CE34                 call    j_@_EH4_CallFilterFunc@8 ; 调用过滤函数</span><br><span class="line">.text:0042CE39                 mov     [ebp+FilterResult], eax ; 返回结果</span><br><span class="line">.text:0042CE3C                 mov     [ebp+Revalidate], 1</span><br><span class="line">.text:0042CE40                 cmp     [ebp+FilterResult], 0 ; 结果是否为 EXCEPTION_CONTINUE_SEARCH（0）</span><br><span class="line">.text:0042CE44                 jge     short loc_42CE57 ; 大于等于0，即0或1，EXCEPTION_EXECUTE_HANDLER (1)</span><br><span class="line">.text:0042CE46                 mov     [ebp+Disposition], 0</span><br><span class="line">.text:0042CE4D                 jmp     loc_42CEEE      ; EXCEPTION_CONTINUE_EXECUTION (-1)</span><br><span class="line">.text:0042CE52 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042CE52                 jmp     loc_42CEE9</span><br><span class="line">.text:0042CE57 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042CE57</span><br><span class="line">.text:0042CE57 loc_42CE57:                             ; CODE XREF: __except_handler4+C4j</span><br><span class="line">.text:0042CE57                 cmp     [ebp+FilterResult], 0</span><br><span class="line">.text:0042CE5B                 jle     loc_42CEE9      ; EXCEPTION_CONTINUE_SEARCH（0）返回值等于0，继续搜索</span><br><span class="line">.text:0042CE61                 mov     ecx, [ebp+ExceptionRecord] ; EXCEPTION_EXECUTE_HANDLER (1) 异常可以被处理</span><br><span class="line">.text:0042CE64                 cmp     dword ptr [ecx], 0E06D7363h</span><br><span class="line">.text:0042CE6A                 jnz     short loc_42CE95</span><br><span class="line">.text:0042CE6C                 cmp     ds:__pDestructExceptionObject, 0	; C++中要将抛出异常的对象析构掉。</span><br><span class="line">.text:0042CE73                 jz      short loc_42CE95</span><br><span class="line">.text:0042CE75                 push    offset __pDestructExceptionObject ; pTarget</span><br><span class="line">.text:0042CE7A                 call    j___IsNonwritableInCurrentImage</span><br><span class="line">.text:0042CE7F                 add     esp, 4</span><br><span class="line">.text:0042CE82                 test    eax, eax</span><br><span class="line">.text:0042CE84                 jz      short loc_42CE95</span><br><span class="line">.text:0042CE86                 push    1               ; fThrowNotAllowed</span><br><span class="line">.text:0042CE88                 mov     edx, [ebp+ExceptionRecord]</span><br><span class="line">.text:0042CE8B                 push    edx             ; pExcept</span><br><span class="line">.text:0042CE8C                 call    ds:__pDestructExceptionObject ; 调用析构的函数</span><br><span class="line">.text:0042CE92                 add     esp, 8</span><br><span class="line">.text:0042CE95</span><br><span class="line">.text:0042CE95 loc_42CE95:                             ; CODE XREF: __except_handler4+EAj</span><br><span class="line">.text:0042CE95                                         ; __except_handler4+F3j ...</span><br><span class="line">.text:0042CE95                 mov     ecx, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CE98                 add     ecx, 8          ; TargetFrame</span><br><span class="line">.text:0042CE9B                 call    j_@_EH4_GlobalUnwind@4 ; _EH4_GlobalUnwind(x) ; 全局展开</span><br><span class="line">.text:0042CEA0                 mov     eax, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CEA3                 mov     ecx, [eax+14h]</span><br><span class="line">.text:0042CEA6                 cmp     ecx, [ebp+TryLevel]</span><br><span class="line">.text:0042CEA9                 jz      short loc_42CEC2</span><br><span class="line">.text:0042CEAB                 push    offset ___security_cookie</span><br><span class="line">.text:0042CEB0                 mov     edx, [ebp+FramePointer]</span><br><span class="line">.text:0042CEB3                 push    edx</span><br><span class="line">.text:0042CEB4                 mov     ecx, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CEB7                 add     ecx, 8</span><br><span class="line">.text:0042CEBA                 mov     edx, [ebp+TryLevel]</span><br><span class="line">.text:0042CEBD                 call    j_@_EH4_LocalUnwind@16 ; _EH4_LocalUnwind(x,x,x,x) ; 局部展开</span><br><span class="line">.text:0042CEC2</span><br><span class="line">.text:0042CEC2 loc_42CEC2:                             ; CODE XREF: __except_handler4+129j</span><br><span class="line">.text:0042CEC2                 mov     eax, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CEC5                 mov     ecx, [ebp+EnclosingLevel]</span><br><span class="line">.text:0042CEC8                 mov     [eax+14h], ecx</span><br><span class="line">.text:0042CECB                 mov     edx, [ebp+FramePointer]</span><br><span class="line">.text:0042CECE                 push    edx             ; FramePointer</span><br><span class="line">.text:0042CECF                 mov     eax, [ebp+ScopeTable]</span><br><span class="line">.text:0042CED2                 push    eax             ; ScopeTable</span><br><span class="line">.text:0042CED3                 call    ValidateLocalCookies					; 再一次校验Cookie，防止被利用</span><br><span class="line">.text:0042CED8                 add     esp, 8</span><br><span class="line">.text:0042CEDB                 mov     edx, [ebp+FramePointer]</span><br><span class="line">.text:0042CEDE                 mov     ecx, [ebp+ScopeTableRecord]</span><br><span class="line">.text:0042CEE1                 mov     ecx, [ecx+8]</span><br><span class="line">.text:0042CEE4                 call    j_@_EH4_TransferToHandler@8 ; _EH4_TransferToHandler(x,x) ; 调用异常处理函数</span><br><span class="line">.text:0042CEE9</span><br><span class="line">.text:0042CEE9 loc_42CEE9:                             ; CODE XREF: __except_handler4+A8j</span><br><span class="line">.text:0042CEE9                                         ; __except_handler4+D2j ...</span><br><span class="line">.text:0042CEE9                 jmp     loc_42CDF3      ; EXCEPTION_CONTINUE_SEARCH（0）</span><br><span class="line">.text:0042CEEE ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042CEEE</span><br><span class="line">.text:0042CEEE loc_42CEEE:                             ; CODE XREF: __except_handler4+7Dj</span><br><span class="line">.text:0042CEEE                                         ; __except_handler4+CDj</span><br><span class="line">.text:0042CEEE                 jmp     short loc_42CF16</span><br><span class="line">.text:0042CEF0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0042CEF0</span><br><span class="line">.text:0042CEF0 loc_42CEF0:                             ; CODE XREF: __except_handler4+4Dj ; 对于展开调用，直接调用局部展开</span><br><span class="line">.text:0042CEF0                 mov     edx, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CEF3                 cmp     dword ptr [edx+14h], 0FFFFFFFEh</span><br><span class="line">.text:0042CEF7                 jz      short loc_42CF16</span><br><span class="line">.text:0042CEF9                 push    offset ___security_cookie</span><br><span class="line">.text:0042CEFE                 mov     eax, [ebp+FramePointer]</span><br><span class="line">.text:0042CF01                 push    eax</span><br><span class="line">.text:0042CF02                 mov     ecx, [ebp+RegistrationNode]</span><br><span class="line">.text:0042CF05                 add     ecx, 8</span><br><span class="line">.text:0042CF08                 mov     edx, 0FFFFFFFEh</span><br><span class="line">.text:0042CF0D                 call    j_@_EH4_LocalUnwind@16 ; _EH4_LocalUnwind(x,x,x,x)</span><br><span class="line">.text:0042CF12                 mov     [ebp+Revalidate], 1</span><br><span class="line">.text:0042CF16</span><br><span class="line">.text:0042CF16 loc_42CF16:                             ; CODE XREF: __except_handler4:loc_42CEEEj</span><br><span class="line">.text:0042CF16                                         ; __except_handler4+177j</span><br><span class="line">.text:0042CF16                 movzx   ecx, [ebp+Revalidate]</span><br><span class="line">.text:0042CF1A                 test    ecx, ecx</span><br><span class="line">.text:0042CF1C                 jz      short loc_42CF2E</span><br><span class="line">.text:0042CF1E                 mov     edx, [ebp+FramePointer]</span><br><span class="line">.text:0042CF21                 push    edx             ; FramePointer</span><br><span class="line">.text:0042CF22                 mov     eax, [ebp+ScopeTable]</span><br><span class="line">.text:0042CF25                 push    eax             ; ScopeTable</span><br><span class="line">.text:0042CF26                 call    ValidateLocalCookies</span><br><span class="line">.text:0042CF2B                 add     esp, 8</span><br><span class="line">.text:0042CF2E</span><br><span class="line">.text:0042CF2E loc_42CF2E:                             ; CODE XREF: __except_handler4+19Cj</span><br><span class="line">.text:0042CF2E                 mov     eax, [ebp+Disposition]</span><br><span class="line">.text:0042CF31                 mov     esp, ebp</span><br><span class="line">.text:0042CF33                 pop     ebp</span><br><span class="line">.text:0042CF34                 retn</span><br><span class="line">.text:0042CF34 __except_handler4 endp</span><br><span class="line">.text:0042CF34</span><br></pre></td></tr></table></figure>
<p>偶然从网上找到了一份<code>_except_handler4</code>的代码，放到这里，和上面的汇编做一个对比吧。对于不想看汇编的朋友，可以直接参考这份源码，与汇编基本相同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br></pre></td><td class="code"><pre><span class="line">/***</span><br><span class="line">*ValidateLocalCookies - perform local cookie validation during SEH processing</span><br><span class="line">*</span><br><span class="line">*Purpose:</span><br><span class="line">*   Perform the security checks for _except_handler4. 执行_except_handler4调用中的安全校验</span><br><span class="line">*</span><br><span class="line">*Entry:</span><br><span class="line">*   CookieCheckFunction - (CRT DLL only) pointer to __security_check_cookie in</span><br><span class="line">*       the target image</span><br><span class="line">*   ScopeTable - pointer to the unencoded scope table from the exception</span><br><span class="line">*       registration record</span><br><span class="line">*   FramePointer - EBP frame pointer for the function that established the</span><br><span class="line">*       exception registration record</span><br><span class="line">*</span><br><span class="line">*Return:</span><br><span class="line">*   If the security checks fail, the process is terminated via a Watson dump.</span><br><span class="line">*   如果安全校验失败，进程会被终止</span><br><span class="line">*******************************************************************************/</span><br><span class="line"></span><br><span class="line">static __declspec(guard(ignore)) void</span><br><span class="line">ValidateLocalCookies(</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">    IN PCOOKIE_CHECK    CookieCheckFunction,</span><br><span class="line">#endif</span><br><span class="line">    IN PEH4_SCOPETABLE  ScopeTable,</span><br><span class="line">    IN PCHAR            FramePointer</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    UINT_PTR        GSCookie;</span><br><span class="line">    UINT_PTR        EHCookie;</span><br><span class="line"></span><br><span class="line">    if (ScopeTable-&gt;GSCookieOffset != NO_GS_COOKIE)</span><br><span class="line">    &#123;</span><br><span class="line">        GSCookie = *(PUINT_PTR)(FramePointer + ScopeTable-&gt;GSCookieOffset);</span><br><span class="line">        GSCookie ^= (UINT_PTR)(FramePointer + ScopeTable-&gt;GSCookieXOROffset);</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">        _GUARD_CHECK_ICALL(CookieCheckFunction);</span><br><span class="line">        (*CookieCheckFunction)(GSCookie);</span><br><span class="line">#else</span><br><span class="line">        __security_check_cookie(GSCookie);</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EHCookie = *(PUINT_PTR)(FramePointer + ScopeTable-&gt;EHCookieOffset);</span><br><span class="line">    EHCookie ^= (UINT_PTR)(FramePointer + ScopeTable-&gt;EHCookieXOROffset);</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">    _GUARD_CHECK_ICALL(CookieCheckFunction);</span><br><span class="line">    (*CookieCheckFunction)(EHCookie);</span><br><span class="line">#else</span><br><span class="line">    __security_check_cookie(EHCookie);</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/***</span><br><span class="line">*_except_handler4 - (non-CRT DLL only) SEH handler with security cookie checks</span><br><span class="line">*</span><br><span class="line">*_except_handler4_common - (CRT DLL only) actual SEH implementation called by</span><br><span class="line">*                          _except_handler4 stub</span><br><span class="line">*</span><br><span class="line">*Purpose:</span><br><span class="line">*   Implement structured exception handling for functions which have __try/</span><br><span class="line">*   __except/__finally.  This version of SEH also performs security cookie</span><br><span class="line">*   checks to detect buffer overruns which potentially corrupt the on-stack</span><br><span class="line">*   exception handling data, terminating the process before such corruption</span><br><span class="line">*   can be exploited.</span><br><span class="line">*</span><br><span class="line">*   Call exception and termination handlers as necessary, based on the current</span><br><span class="line">*   execution point within the function.</span><br><span class="line">*</span><br><span class="line">*Entry:</span><br><span class="line">*   CookiePointer - (CRT DLL only) pointer to the global security cookie to be</span><br><span class="line">*       used to decode the scope table pointer in the exception registration</span><br><span class="line">*       record</span><br><span class="line">*   CookieCheckFunction - (CRT DLL only) pointer to __security_check_cookie in</span><br><span class="line">*       the calling image</span><br><span class="line">*   ExceptionRecord - pointer to the exception being dispatched</span><br><span class="line">*   EstablisherFrame - pointer to the on-stack exception registration record</span><br><span class="line">*       for this function</span><br><span class="line">*   ContextRecord - pointer to a context record for the point of exception</span><br><span class="line">*   DispatcherContext - pointer to the exception dispatcher or unwind</span><br><span class="line">*       dispatcher context</span><br><span class="line">*</span><br><span class="line">*Return:</span><br><span class="line">*   If the security checks fail, the process is terminated via a Watson dump.</span><br><span class="line">*</span><br><span class="line">*   If an exception is being dispatched and the exception is handled by an</span><br><span class="line">*   __except filter for this exception frame, then this function does not</span><br><span class="line">*   return.  Instead, it calls RtlUnwind and transfers control to the __except</span><br><span class="line">*   block corresponding to the accepting __except filter.  Otherwise, an</span><br><span class="line">*   exception disposition of continue execution or continue search is returned.</span><br><span class="line">*</span><br><span class="line">*   If an unwind is being dispatched, then each termination handler (__finally)</span><br><span class="line">*   is called and a value of continue search is returned.</span><br><span class="line">*</span><br><span class="line">*******************************************************************************/</span><br><span class="line"></span><br><span class="line">EXCEPTION_DISPOSITION</span><br><span class="line">#if !defined(CRTDLL)</span><br><span class="line">_except_handler4(</span><br><span class="line">#else</span><br><span class="line">_except_handler4_common(</span><br><span class="line">    IN PUINT_PTR                        CookiePointer,</span><br><span class="line">    IN PCOOKIE_CHECK                    CookieCheckFunction,</span><br><span class="line">#endif</span><br><span class="line">    IN PEXCEPTION_RECORD                ExceptionRecord,</span><br><span class="line">    IN PEXCEPTION_REGISTRATION_RECORD   EstablisherFrame,</span><br><span class="line">    IN OUT PCONTEXT                     ContextRecord,</span><br><span class="line">    IN OUT PVOID                        DispatcherContext</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    PEH4_EXCEPTION_REGISTRATION_RECORD  RegistrationNode;</span><br><span class="line">    PCHAR                               FramePointer;</span><br><span class="line">    PEH4_SCOPETABLE                     ScopeTable;</span><br><span class="line">    ULONG                               TryLevel;</span><br><span class="line">    ULONG                               EnclosingLevel;</span><br><span class="line">    EXCEPTION_POINTERS                  ExceptionPointers;</span><br><span class="line">    PEH4_SCOPETABLE_RECORD              ScopeTableRecord;</span><br><span class="line">    PEXCEPTION_FILTER                   FilterFunc;</span><br><span class="line">    LONG                                FilterResult;</span><br><span class="line">    BOOLEAN                             Revalidate = FALSE;</span><br><span class="line">    EXCEPTION_DISPOSITION               Disposition = ExceptionContinueSearch;</span><br><span class="line">    //</span><br><span class="line">    // We are passed a registration record which is a field offset from the</span><br><span class="line">    // start of our true registration record.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    RegistrationNode =</span><br><span class="line">        (PEH4_EXCEPTION_REGISTRATION_RECORD)</span><br><span class="line">        ( (PCHAR)EstablisherFrame -</span><br><span class="line">          FIELD_OFFSET(EH4_EXCEPTION_REGISTRATION_RECORD, SubRecord) );</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // The EBP frame pointer in the function corresponding to the registration</span><br><span class="line">    // record will be immediately following the record.  If the function uses</span><br><span class="line">    // FPO, this is a &quot;virtual&quot; frame pointer outside of exception handling,</span><br><span class="line">    // but it&apos;s still the EBP value set when calling into the handlers or</span><br><span class="line">    // filters.</span><br><span class="line">    // 在注册的异常块信息之后就是EBP帧指针，对于省略栈帧情况，在异常处理之外，这里是一个虚拟的栈帧值</span><br><span class="line"></span><br><span class="line">    FramePointer = (PCHAR)(RegistrationNode + 1);</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // Retrieve the scope table pointer, which encodes where we find the local</span><br><span class="line">    // security cookies within the function&apos;s frame, as well as how the guarded</span><br><span class="line">    // blocks in the target function are laid out.  This pointer was XORed with</span><br><span class="line">    // the image-local global security cookie when originally stored, to avoid</span><br><span class="line">    // attacks which spoof the table to address valid local cookies elsewhere</span><br><span class="line">    // on the stack.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">    ScopeTable = (PEH4_SCOPETABLE)</span><br><span class="line">                    (RegistrationNode-&gt;EncodedScopeTable ^ *CookiePointer);</span><br><span class="line">#else</span><br><span class="line">    ScopeTable = (PEH4_SCOPETABLE)</span><br><span class="line">                    (RegistrationNode-&gt;EncodedScopeTable ^ __security_cookie);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // Perform the initial security cookie validation.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    ValidateLocalCookies(</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">        CookieCheckFunction,</span><br><span class="line">#endif</span><br><span class="line">        ScopeTable,</span><br><span class="line">        FramePointer</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    __except_validate_context_record(ContextRecord);</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // Security checks have passed, begin actual exception handling.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    if (IS_DISPATCHING(ExceptionRecord-&gt;ExceptionFlags))</span><br><span class="line">    &#123;</span><br><span class="line">        //</span><br><span class="line">        // An exception dispatch is in progress.  First build the</span><br><span class="line">        // EXCEPTION_POINTERS record queried by the _exception_info intrinsic</span><br><span class="line">        // and save it in the exception registration record so the __except</span><br><span class="line">        // filter can find it.</span><br><span class="line">        //</span><br><span class="line"></span><br><span class="line">        ExceptionPointers.ExceptionRecord = ExceptionRecord;</span><br><span class="line">        ExceptionPointers.ContextRecord = ContextRecord;</span><br><span class="line">        RegistrationNode-&gt;ExceptionPointers = &amp;ExceptionPointers;</span><br><span class="line"></span><br><span class="line">        //</span><br><span class="line">        // Scan the scope table and call the appropriate __except filters until</span><br><span class="line">        // we find one that accepts the exception.</span><br><span class="line">        //</span><br><span class="line"></span><br><span class="line">        for (TryLevel = RegistrationNode-&gt;TryLevel;</span><br><span class="line">             TryLevel != TOPMOST_TRY_LEVEL;</span><br><span class="line">             TryLevel = EnclosingLevel)</span><br><span class="line">        &#123;</span><br><span class="line">            ScopeTableRecord = &amp;ScopeTable-&gt;ScopeRecord[TryLevel];</span><br><span class="line">            FilterFunc = ScopeTableRecord-&gt;FilterFunc;</span><br><span class="line">            EnclosingLevel = ScopeTableRecord-&gt;EnclosingLevel;</span><br><span class="line"></span><br><span class="line">            if (FilterFunc != NULL)</span><br><span class="line">            &#123;</span><br><span class="line">                //</span><br><span class="line">                // The current scope table record is for an __except.</span><br><span class="line">                // Call the __except filter to see if we&apos;ve found an</span><br><span class="line">                // accepting handler.</span><br><span class="line">                //</span><br><span class="line"></span><br><span class="line">                FilterResult = _EH4_CallFilterFunc(FilterFunc, FramePointer);</span><br><span class="line">                Revalidate = TRUE;</span><br><span class="line"></span><br><span class="line">                //</span><br><span class="line">                // If the __except filter returned a negative result, then</span><br><span class="line">                // dismiss the exception.  If it returned a positive result,</span><br><span class="line">                // unwind to the accepting exception handler.  Otherwise keep</span><br><span class="line">                // searching for an exception filter.</span><br><span class="line">                //</span><br><span class="line"></span><br><span class="line">                if (FilterResult &lt; 0) 	// -1 继续执行，再次对异常代码执行一次</span><br><span class="line">                &#123;</span><br><span class="line">                    Disposition = ExceptionContinueExecution;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (FilterResult &gt; 0)	// 执行异常处理器，这时要进行展开动作</span><br><span class="line">                &#123;</span><br><span class="line">#if !defined(_NTSUBSET_)</span><br><span class="line">                    //</span><br><span class="line">                    // If we&apos;re handling a thrown C++ exception, let the C++</span><br><span class="line">                    // exception handler destruct the thrown object.  This call</span><br><span class="line">                    // is through a function pointer to avoid linking to the</span><br><span class="line">                    // C++ EH support unless it&apos;s already present.  Don&apos;t call</span><br><span class="line">                    // the function pointer unless it&apos;s in read-only memory.</span><br><span class="line">                    //</span><br><span class="line"></span><br><span class="line">                    if (ExceptionRecord-&gt;ExceptionCode == EH_EXCEPTION_NUMBER &amp;&amp;</span><br><span class="line">                        _pDestructExceptionObject != NULL &amp;&amp;</span><br><span class="line">                        _IsNonwritableInCurrentImage((PBYTE)&amp;_pDestructExceptionObject))</span><br><span class="line">                    &#123;</span><br><span class="line">                        (*_pDestructExceptionObject)(ExceptionRecord, TRUE);</span><br><span class="line">                    &#125;</span><br><span class="line">#endif  // !defined(_NTSUBSET_)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    //</span><br><span class="line">                    // Unwind all registration nodes below this one, then unwind</span><br><span class="line">                    // the nested __try levels.</span><br><span class="line">                    //</span><br><span class="line">                    _EH4_GlobalUnwind2(</span><br><span class="line">                        &amp;RegistrationNode-&gt;SubRecord,</span><br><span class="line">                        ExceptionRecord</span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">                    if (RegistrationNode-&gt;TryLevel != TryLevel)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _EH4_LocalUnwind(</span><br><span class="line">                            &amp;RegistrationNode-&gt;SubRecord,</span><br><span class="line">                            TryLevel,</span><br><span class="line">                            FramePointer,</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">                            CookiePointer</span><br><span class="line">#else</span><br><span class="line">                            &amp;__security_cookie</span><br><span class="line">#endif</span><br><span class="line">                            );</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    //</span><br><span class="line">                    // Set the __try level to the enclosing level, since it is</span><br><span class="line">                    // the enclosing level, if any, that guards the __except</span><br><span class="line">                    // handler.</span><br><span class="line">                    //</span><br><span class="line"></span><br><span class="line">                    RegistrationNode-&gt;TryLevel = EnclosingLevel;</span><br><span class="line"></span><br><span class="line">                    //</span><br><span class="line">                    // Redo the security checks, in case any __except filters</span><br><span class="line">                    // or __finally handlers have caused overruns in the target</span><br><span class="line">                    // frame.</span><br><span class="line">                    //</span><br><span class="line"></span><br><span class="line">                    ValidateLocalCookies(</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">                        CookieCheckFunction,</span><br><span class="line">#endif</span><br><span class="line">                        ScopeTable,</span><br><span class="line">                        FramePointer</span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">                    //</span><br><span class="line">                    // Call the __except handler.  This call will not return.</span><br><span class="line">                    // The __except handler will reload ESP from the</span><br><span class="line">                    // registration record upon entry.  The EBP frame pointer</span><br><span class="line">                    // for the handler is directly after the registration node.</span><br><span class="line">                    //</span><br><span class="line"></span><br><span class="line">                    _EH4_TransferToHandler(</span><br><span class="line">                        ScopeTableRecord-&gt;u.HandlerAddress,</span><br><span class="line">                        FramePointer</span><br><span class="line">                        );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        //</span><br><span class="line">        // An exception unwind is in progress, and this isn&apos;t the target of the</span><br><span class="line">        // unwind.  Unwind any active __try levels in this function, calling</span><br><span class="line">        // the applicable __finally handlers.</span><br><span class="line">        //</span><br><span class="line"></span><br><span class="line">        if (RegistrationNode-&gt;TryLevel != TOPMOST_TRY_LEVEL)</span><br><span class="line">        &#123;</span><br><span class="line">            _EH4_LocalUnwind(</span><br><span class="line">                &amp;RegistrationNode-&gt;SubRecord,</span><br><span class="line">                TOPMOST_TRY_LEVEL,</span><br><span class="line">                FramePointer,</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">                CookiePointer</span><br><span class="line">#else</span><br><span class="line">                &amp;__security_cookie</span><br><span class="line">#endif</span><br><span class="line">                );</span><br><span class="line">            Revalidate = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // If we called any __except filters or __finally handlers, then redo the</span><br><span class="line">    // security checks, in case those funclets have caused overruns in the</span><br><span class="line">    // target frame.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    if (Revalidate)</span><br><span class="line">    &#123;</span><br><span class="line">        ValidateLocalCookies(</span><br><span class="line">#if defined(CRTDLL)</span><br><span class="line">            CookieCheckFunction,</span><br><span class="line">#endif</span><br><span class="line">            ScopeTable,</span><br><span class="line">            FramePointer</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // Continue searching for exception or termination handlers in previous</span><br><span class="line">    // registration records higher up the stack, or resume execution if we&apos;re</span><br><span class="line">    // here because an __except filter returned a negative result.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    return Disposition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>_except_handler4</code>函数中有两个函数<code>_EH4_CallFilterFunc</code>和<code>_EH4_TransferToHandler</code>，他们都是跳转到对应的函数去，代码比较简单，列举出IDA的反汇编代码如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.text:004312D2 ; __fastcall _EH4_CallFilterFunc(x, x)</span><br><span class="line">.text:004312D2 @_EH4_CallFilterFunc@8 proc near        ; CODE XREF: _EH4_CallFilterFunc(x,x)j</span><br><span class="line">.text:004312D2                 push    ebp</span><br><span class="line">.text:004312D3                 push    esi</span><br><span class="line">.text:004312D4                 push    edi</span><br><span class="line">.text:004312D5                 push    ebx</span><br><span class="line">.text:004312D6                 mov     ebp, edx</span><br><span class="line">.text:004312D8                 xor     eax, eax</span><br><span class="line">.text:004312DA                 xor     ebx, ebx</span><br><span class="line">.text:004312DC                 xor     edx, edx</span><br><span class="line">.text:004312DE                 xor     esi, esi</span><br><span class="line">.text:004312E0                 xor     edi, edi</span><br><span class="line">.text:004312E2                 call    ecx</span><br><span class="line">.text:004312E4                 pop     ebx</span><br><span class="line">.text:004312E5                 pop     edi</span><br><span class="line">.text:004312E6                 pop     esi</span><br><span class="line">.text:004312E7                 pop     ebp</span><br><span class="line">.text:004312E8                 retn</span><br><span class="line">.text:004312E8 @_EH4_CallFilterFunc@8 endp</span><br><span class="line"></span><br><span class="line">.text:004312E9 ; __fastcall _EH4_TransferToHandler(x, x)</span><br><span class="line">.text:004312E9 @_EH4_TransferToHandler@8 proc near     ; CODE XREF: _EH4_TransferToHandler(x,x)j</span><br><span class="line">.text:004312E9                 mov     ebp, edx</span><br><span class="line">.text:004312EB                 mov     esi, ecx</span><br><span class="line">.text:004312ED                 mov     eax, ecx</span><br><span class="line">.text:004312EF                 push    1</span><br><span class="line">.text:004312F1                 call    j___NLG_Notify</span><br><span class="line">.text:004312F6                 xor     eax, eax</span><br><span class="line">.text:004312F8                 xor     ebx, ebx</span><br><span class="line">.text:004312FA                 xor     ecx, ecx</span><br><span class="line">.text:004312FC                 xor     edx, edx</span><br><span class="line">.text:004312FE                 xor     edi, edi</span><br><span class="line">.text:00431300                 jmp     esi</span><br><span class="line">.text:00431300 @_EH4_TransferToHandler@8 endp</span><br></pre></td></tr></table></figure>
<p>由上述的<code>_except_handler4</code>代码可知，异常处理时有三种情况，<code>EXCEPTION_CONTINUE_SEARCH</code>，<code>EXCEPTION_CONTINUE_EXECUTION</code>，<code>EXCEPTION_EXECUTE_HANDLER</code>。<code>EXCEPTION_CONTINUE_SEARCH</code>比较好理解，继续搜索异常处理函数；<code>EXCEPTION_CONTINUE_EXECUTION</code>是退出异常处理，继续执行异常代码，从代码中可以看到，赋值局部变量后，直接break掉了搜索循环；最后一个<code>EXCEPTION_EXECUTE_HANDLER</code>是要执行异常处理函数，从上面的分析中可以知道异常处理函数并不一定处于异常发生的地方，可能在调用栈很高的位置，这个时候要执行它就需要将栈帧回退到它所在函数。对于正常的执行过程中，执行了处理函数，是接着要执行后面的代码的，那异常处理函数（代码段）之后的函数栈帧怎么办呢？就是要进行展开了，一方面退掉他们所占用的栈，另一方面释放掉他们申请的资源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">void __stdcall RtlUnwind(PVOID TargetFrame, PVOID TargetIp, PEXCEPTION_RECORD ExceptionRecord, PVOID ReturnValue)</span><br><span class="line">&#123;</span><br><span class="line">  int v4; // ebp@0</span><br><span class="line">  PEXCEPTION_RECORD v5; // esi@1</span><br><span class="line">  unsigned int v6; // eax@5</span><br><span class="line">  unsigned int v7; // ebx@5</span><br><span class="line">  void *v8; // eax@12</span><br><span class="line">  int v9; // eax@15</span><br><span class="line">  unsigned int v10; // eax@16</span><br><span class="line">  unsigned int v11; // [sp+8h] [bp-37Ch]@2</span><br><span class="line">  int v12; // [sp+Ch] [bp-378h]@2</span><br><span class="line">  int v13; // [sp+10h] [bp-374h]@2</span><br><span class="line">  int v14; // [sp+14h] [bp-370h]@2</span><br><span class="line">  int v15; // [sp+18h] [bp-36Ch]@2</span><br><span class="line">  EXCEPTION_RECORD v16; // [sp+58h] [bp-32Ch]@20</span><br><span class="line">  unsigned int v17; // [sp+A8h] [bp-2DCh]@15</span><br><span class="line">  unsigned int LowLimit; // [sp+ACh] [bp-2D8h]@1</span><br><span class="line">  unsigned int HighLimit; // [sp+B0h] [bp-2D4h]@1</span><br><span class="line">  CONTEXT Context; // [sp+B4h] [bp-2D0h]@5</span><br><span class="line">  int retaddr; // [sp+388h] [bp+4h]@2</span><br><span class="line"></span><br><span class="line">  v5 = ExceptionRecord;</span><br><span class="line">  RtlpGetStackLimits(&amp;LowLimit, &amp;HighLimit);    // 获取当前堆栈的最大最小值，防止后面获取值超出范围</span><br><span class="line">  if ( !ExceptionRecord )						// 构建EXCEPTION_RECORD结构体</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (PEXCEPTION_RECORD)&amp;v11;</span><br><span class="line">    v11 = 0xC0000027;                           // STATUS_UNWIND</span><br><span class="line">    v12 = 0;</span><br><span class="line">    v13 = 0;</span><br><span class="line">    v14 = retaddr;</span><br><span class="line">    v15 = 0;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( TargetFrame )</span><br><span class="line">    v5-&gt;ExceptionFlags |= 2u;                   // EXCEPTION_UNWINDING</span><br><span class="line">  else</span><br><span class="line">    v5-&gt;ExceptionFlags |= 6u;					// EXCEPTION_UNWINDING | EXCEPTION_EXIT_UNWIND</span><br><span class="line">  Context.ContextFlags = 0x10007;</span><br><span class="line">  RtlpCaptureContext(v4, (int)&amp;Context);        // 填充Context结构体</span><br><span class="line">  Context.Esp += 16;</span><br><span class="line">  Context.Eax = (unsigned int)ReturnValue;</span><br><span class="line">  RtlpGetRegistrationHead();                    // 获取线程异常链头指针</span><br><span class="line">  v7 = v6;</span><br><span class="line">  while ( v7 != 0xFFFFFFFF )                    // 开始遍历异常链，直到目标Frame</span><br><span class="line">  &#123;</span><br><span class="line">    if ( (PVOID)v7 == TargetFrame )             // 到了目标帧，直接返回</span><br><span class="line">    &#123;</span><br><span class="line">      ZwContinue(&amp;Context, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( TargetFrame &amp;&amp; (unsigned int)TargetFrame &lt; v7 )// 当前帧大于目标帧地址，这是出现了错误的。</span><br><span class="line">    &#123;</span><br><span class="line">      v16.NumberParameters = 0;</span><br><span class="line">      v16.ExceptionCode = 0xC0000029;           // STATUS_INVALID_UNWIND_TARGET 展开目标无效，抛出异常</span><br><span class="line">      v16.ExceptionFlags = 1;</span><br><span class="line">      v16.ExceptionRecord = v5;</span><br><span class="line">      RtlRaiseException(&amp;v16);</span><br><span class="line">    &#125;</span><br><span class="line">    if ( v7 &lt; LowLimit</span><br><span class="line">      || v7 + 8 &gt; HighLimit</span><br><span class="line">      || v7 &amp; 3</span><br><span class="line">      || (v8 = *(void **)(v7 + 4), (unsigned int)v8 &gt;= LowLimit) &amp;&amp; (unsigned int)v8 &lt; HighLimit</span><br><span class="line">      || !RtlIsValidHandler(v8, 0) )            // 当前帧异常，超出栈限制，且其中的处理函数无效，则抛出异常</span><br><span class="line">    &#123;</span><br><span class="line">      v16.NumberParameters = 0;</span><br><span class="line">      v16.ExceptionCode = 0xC0000028;           // STATUS_BAD_STACK</span><br><span class="line">      v16.ExceptionFlags = 1;</span><br><span class="line">      v16.ExceptionRecord = v5;</span><br><span class="line">      RtlRaiseException(&amp;v16);</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = RtlpExecuteHandlerForUnwind(v5, v7, &amp;Context, &amp;v17, *(_DWORD *)(v7 + 4)) - 1;// 调用异常处理函数（except块）</span><br><span class="line">    if ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( v9 != 2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v16.NumberParameters = 0;</span><br><span class="line">        v16.ExceptionCode = 0xC0000026;         // STATUS_INVALID_DISPOSITION</span><br><span class="line">        v16.ExceptionFlags = 1;</span><br><span class="line">        v16.ExceptionRecord = v5;</span><br><span class="line">        RtlRaiseException(&amp;v16);</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = v17;</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = v7;</span><br><span class="line">    v7 = *(_DWORD *)v7;                         // 继续循环</span><br><span class="line">    RtlpUnlinkHandler((int *)v10);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( TargetFrame == (PVOID)-1 )</span><br><span class="line">    ZwContinue(&amp;Context, 0);</span><br><span class="line">  else</span><br><span class="line">    ZwRaiseException(v5, &amp;Context, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述反汇编的代码中可以看到，展开过程最终会调用<code>RtlpExecuteHandlerForUnwind</code>函数，它其实就是一个用它自己最后一个参数作为函数指针调用该函数指针指向函数的包装。从v7指向异常信息注册块可知，函数指针指向的是<code>_except_handler4</code>函数，只是传参不同。代码中的<code>ExceptionRecord-&gt;ExceptionFlags</code>标记中带有<code>EXCEPTION_UNWINDING</code>，表明是展开操作，在<code>_except_handler4</code>中就会走到不同的路径，即局部展开中。这里就解释了一个问题，为什么<code>_except_handler4</code>在异常处理时为什么会被两次调用，一次用于异常处理函数搜索，一次用于栈展开。</p>
<p>这里要说一下全局展开（<code>_EH4_GlobalUnwind</code>）和局部展开（<code>_EH4_LocalUnwind</code>）的区别，比较容易混淆两个概念。全局展开即遍历TEB中异常链表中当前遍历中命中的异常信息记录节点之前的所有节点（遍历中要对每一个节点执行局部展开）。而局部展开是针对某一个具体的异常信息记录节点，即对应一个函数的异常处理信息。它内部可能包含多个try语句，并且try可能进行嵌套。局部展开的工作就是执行该节点中每一个try语句的处理函数（代码块）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">int __usercall _local_unwind4@&lt;eax&gt;(int FramePointer@&lt;ebp&gt;, _DWORD *CookiePointer, int EstablisherFrame, unsigned int TargetLevel)</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax@2</span><br><span class="line">  unsigned int v5; // esi@2</span><br><span class="line">  int v6; // esi@5</span><br><span class="line">  int v7; // ebx@5</span><br><span class="line">  int v8; // [sp-8h] [bp-28h]@1</span><br><span class="line">  signed int (__cdecl *v9)(int, int, int, _DWORD *); // [sp-4h] [bp-24h]@1</span><br><span class="line">  unsigned int v10; // [sp+0h] [bp-20h]@1</span><br><span class="line">  unsigned int v11; // [sp+4h] [bp-1Ch]@1</span><br><span class="line">  int v12; // [sp+8h] [bp-18h]@1</span><br><span class="line">  _DWORD *v13; // [sp+Ch] [bp-14h]@1</span><br><span class="line"></span><br><span class="line">  v13 = CookiePointer;</span><br><span class="line">  v12 = EstablisherFrame;</span><br><span class="line">  v11 = TargetLevel;</span><br><span class="line">  v9 = unwind_handler4;</span><br><span class="line">  v10 = (unsigned int)&amp;v8 ^ __security_cookie;</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = EstablisherFrame;</span><br><span class="line">    v5 = *(_DWORD *)(EstablisherFrame + 12);</span><br><span class="line">    if ( v5 == 0xFFFFFFFE || TargetLevel != 0xFFFFFFFE &amp;&amp; v5 &lt;= TargetLevel ) // &gt;</span><br><span class="line">      break;</span><br><span class="line">    v6 = 3 * v5;</span><br><span class="line">    v7 = (*CookiePointer ^ *(_DWORD *)(EstablisherFrame + 8)) + 4 * v6 + 16;</span><br><span class="line">    *(_DWORD *)(EstablisherFrame + 12) = *(_DWORD *)((*CookiePointer ^ *(_DWORD *)(EstablisherFrame + 8)) + 4 * v6 + 0x10);</span><br><span class="line">    if ( !*(_DWORD *)(v7 + 4) )</span><br><span class="line">    &#123;</span><br><span class="line">      _NLG_Notify(*(_DWORD *)(v7 + 8), FramePointer, 0x101);</span><br><span class="line">      _NLG_Call(*(int (**)(void))(v7 + 8));     // 调用对应的Handler</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样上述函数就比较容易理解了，就是对给定的异常信息节点EstablisherFrame，逐一遍历其中的ScopeTable表项，并调用对应的ExecuteFunc。</p>
<p>这样对于异常处理的分析就结束了，可能有地方理解不对，欢迎提出。后面发现有什么新的内容，再添加吧。</p>
<p><strong>未总结内容</strong></p>
<ol>
<li>“ExceptionNestedException 和 ExceptionCollidedUnwind”</li>
<li>SafeSEH的缓解措施</li>
</ol>
<p><strong>参考文章</strong></p>
<ol>
<li><a href="http://boxcounter.com/technique/2011-10-19-seh-x86/" target="_blank" rel="noopener">SEH分析笔记（X86篇）</a></li>
<li><a href="https://dbglife.github.io/2017/06/14/Win32-SEH-Internals.html" target="_blank" rel="noopener">Windows异常处理</a></li>
</ol>
<p><strong>修订历史</strong></p>
<ul>
<li>2017-08-01 16:51:23        完成文章</li>
</ul>
<p>By Andy @2017-08-01 16:51:23</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/调试/">调试</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Windbg/">Windbg</a><a href="/tags/Exception/">Exception</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://dbgtech.github.io/2017/07/26/VS2008-Windows-Try-Except-Finally.html" data-title="Windows X86的ring3结构化异常处理 | DbgTech" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/08/04/Windows-X64-Try-Except-Finally.html" title="Windows X64的Ring3层异常处理机制">
  <strong>上一篇：</strong><br/>
  <span>
  Windows X64的Ring3层异常处理机制</span>
</a>
</div>


<div class="next">
<a href="/2017/07/26/read-dark-time-log.html"  title="《暗时间》读书笔记">
 <strong>下一篇：</strong><br/> 
 <span>《暗时间》读书笔记
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  <div class="linkslist">
  <p class="asidetitle">专栏</p>
    <ul>
        
          <li>
            
            	<a href="https://dbgtech.github.io/Tools/" target="_blank" title="常用工具">常用工具</a>
            
          </li>
        
    </ul>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/散记/" title="散记">散记<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/笔记/" title="笔记">笔记<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/翻译/笔记/" title="笔记">笔记<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/翻译/" title="翻译">翻译<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/读书/" title="读书">读书<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/调试/" title="调试">调试<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/转载/" title="转载">转载<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Windbg/" title="Windbg">Windbg<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Exception/" title="Exception">Exception<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Windows/" title="Windows">Windows<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/心情/" title="心情">心情<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/X86汇编/" title="X86汇编">X86汇编<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Markdown/" title="Markdown">Markdown<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/笔记/" title="笔记">笔记<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Stack-Cookie/" title="Stack Cookie">Stack Cookie<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/time/" title="time">time<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C-C/" title="C/C++">C/C++<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Win10/" title="Win10">Win10<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UWP/" title="UWP">UWP<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/读书笔记/" title="读书笔记">读书笔记<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C-C/" title="C\C++">C\C++<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/反思/" title="反思">反思<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/翻译/" title="翻译">翻译<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/实模式/" title="实模式">实模式<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/保护模式/" title="保护模式">保护模式<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/运行时库/" title="运行时库">运行时库<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/WSL/" title="WSL">WSL<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://git-scm.com/book/zh/v2" target="_blank" title="Git">Git</a>
            
          </li>
        
          <li>
            
            	<a href="https://hexo.io/zh-cn/docs/" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="http://36kr.com/" target="_blank" title="36氪">36氪</a>
            
          </li>
        
          <li>
            
            	<a href="https://wiki.osdev.org/Expanded_Main_Page" target="_blank" title="OSDev">OSDev</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.reactos.com/" target="_blank" title="ReactOS">ReactOS</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.freebuf.com/" target="_blank" title="FreeBuf">FreeBuf</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.appinn.com/markdown/" target="_blank" title="Makedown">Makedown</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.huxiu.com/" target="_blank" title="虎嗅网">虎嗅网</a>
            
          </li>
        
          <li>
            
            	<a href="http://bbs.pediy.com/" target="_blank" title="看雪论坛">看雪论坛</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.geekpark.net/" target="_blank" title="极客公园">极客公园</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li></ul>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Andy Guo">Andy Guo</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

